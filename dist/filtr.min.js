/*!
 * filtr - MongoDB inspired array filtering
 * Copyright(c) 2012 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */


!function(a,b){typeof module!="undefined"?module.exports=b():typeof define=="function"&&typeof define.amd=="object"?define(b):this[a]=b()}("filtr",function(){function c(a,b){if(a&&b)for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function d(a){if(global==this)return new d(a);this.query=a,this.stack=this.parseQuery(a)}if(!a)var a={};var b={$and:!0,$or:!0,$nor:!0};return a.exports=d,d.version="0.1.0",d.comparators={$gt:function(a,b){return a>b},$gte:function(a,b){return a>=b},$lt:function(a,b){return a<b},$lte:function(a,b){return a<=b},$all:function(a,b){for(var c=0;c<b.length;c++)if(!~a.indexOf(b[c]))return!1;return!0},$exists:function(a,b){return!!a==b},$mod:function(a,b){return a%b[0]==b[1]},$eq:function(a,b){return a==b},$ne:function(a,b){return a!=b},$in:function(a,b){return~b.indexOf(a)?!0:!1},$nin:function(a,b){return~b.indexOf(a)?!1:!0},$size:function(a,b){return a.length&&b?a.length==b:!1},$or:function(a){var b=!1;for(var c=0;c<a.length;c++){var d=a[c];d&&(b=!0)}return b},$nor:function(a){var b=!0;for(var c=0;c<a.length;c++){var d=a[c];d&&(b=!1)}return b},$and:function(a){var b=!0;for(var c=0;c<a.length;c++){var d=a[c];d||(b=!1)}return b}},d.parsePath=function(a){var b=a.split(".").filter(Boolean);return b.map(function(a){var b=/([A-Za-z0-9]+)\[(\d+)\]$/,c=b.exec(a),d;return c&&(d={p:c[1],i:c[2]}),d||a})},d.getPathValue=function(a,b){var c=b,d;for(var e=0,f=a.length;e<f;e++){var g=a[e];c?("object"==typeof g&&c[g.p]?c=c[g.p][g.i]:c=c[g],e==f-1&&(d=c)):d=undefined}return d},d.prototype.test=function(a,b){var e={type:"set",spec:"subset"},f=c(b||{},e),g=f.type=="single"?!1:[],h,i;f.type=="single"&&(a=[a]);for(var j=0,k=a.length;j<k;j++){var l=a[j],m=!0;for(var n=0,o=this.stack.length;n<o;n++)h=this.stack[n],i=h.path?d.getPathValue(h.path,l):l,this.testFilter(i,h.test)||(m=!1);if(f.type=="single")g=m;else switch(f.spec){case"boolean":g.push(m);break;case"index":m&&g.push(j);break;default:m&&g.push(l)}}return g},d.prototype.parseQuery=function(a){var b=[];for(var c in a){var e={},f=a[c];c[0]=="$"?e.test=this.parseFilter(a):(e.test=this.parseFilter(f),e.path=d.parsePath(c)),b.push(e)}return b},d.prototype.parseFilter=function(a){var c=[];for(var e in a){var f=d.comparators[e],g=a[e],h=!1;if(b[e]){var i=[];for(var j=0;j<g.length;j++)i.push(this.parseFilter(g[j]));h=!0}c.push({fn:f,params:h?i:g,traverse:h})}return c},d.prototype.testFilter=function(a,b){var c=!0;for(var d=0;d<b.length;d++){var e=b[d],f=e.params;if(e.traverse){var g=[];for(var h=0;h<f.length;h++){var i=f[h];g.push(this.testFilter(a,i))}f=g}e.fn.length==1?e.fn(f)||(c=!1):e.fn(a,f)||(c=!1)}return c},a.exports})